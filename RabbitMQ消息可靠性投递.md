# RabbitMQ消息可靠性投递

保证消息100%投递成功。

添加发送端接收MQ节点（Broker）确认应答的逻辑，如果发送端收到确认应答信息则投递成功，  
可能有两种异常：消息发送失败；接受确认应答消息失败。  

互联网大厂针对上面问题的解决方案：  
下面两种操作中都不对数据添加事务管理。

1、消息落库，对消息状态进行打标  
![](https://upload-images.jianshu.io/upload_images/426671-5af2da37ddcf30c0.png?imageMogr2/auto-orient/)  
1）存储消息到数据库，并设置状态；  
2）发送消息成功（收到应答），修改消息状态；  
3）对状态为未成功发送的消息，进行轮询（如每隔10秒轮询一次）重发（有最大重试次数）；  
4）经过上面步骤可能还有少量的消息传递失败，这时需要，额外处理，给出失败原因。  
这种处理方法并不适合高并发场景，因为数据库操作太多。  

2、消息的延迟投递，做二次确认，回调检查   
![](https://upload-images.jianshu.io/upload_images/426671-5d9cfdda2cf2fc84.png?imageMogr2/auto-orient/)  
1）上层业务按正常时间先发送一次消息，并设置N分钟后重新发送；
2）消息发送到MQ节点（可能是负载均衡的集群），消费Listener监听消息并发给下层服务处理
3）下层服务处理完成，发送一个confirm消息到MQ节点，失败补偿服务（callback service）
这种方式可以有效减少数据库操作，性能更好。